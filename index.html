<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPLBanters 2025</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#f4f4f4">
    <link rel="icon" href="./icon.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f4;
        }
        h1, h2, h3, h4 {
            text-align: center;
            color: #333;
        }
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab {
            padding: 10px 20px;
            background: #ddd;
            cursor: pointer;
            margin: 5px;
            border-radius: 4px;
        }
        .tab.active {
            background: #007bff;
            color: #fff;
        }
        .tab.hidden {
            display: none;
        }
        .sub-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
        }
        .sub-tab {
            padding: 8px 16px;
            background: #e9ecef;
            cursor: pointer;
            margin: 5px;
            border-radius: 4px;
        }
        .sub-tab.active {
            background: #28a745;
            color: #fff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .sub-tab-content {
            display: none;
        }
        .sub-tab-content.active {
            display: block;
        }
        .user-container, .form-container, .predictions, .leaderboard, .results-container, .admin-container {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        input, select, button {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #28a745;
            color: #fff;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #218838;
        }
        .danger-button {
            background-color: #dc3545;
        }
        .danger-button:hover {
            background-color: #c82333;
        }
        .edit-button {
            background-color: #007bff;
            margin-right: 10px;
        }
        .edit-button:hover {
            background-color: #0056b3;
        }
        .drs-button {
            background-color: #ffc107;
            color: #333;
            width: auto;
            padding: 8px 16px;
            margin-top: 10px;
            display: inline-block;
        }
        .drs-button:hover {
            background-color: #e0a800;
        }
        .small-button {
            padding: 6px 12px;
            font-size: 12px;
            width: auto;
            display: inline-block;
        }
        .error {
            color: red;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .success {
            color: green;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .users-list, .predictions, .results-list, .matches-list, .winners-list {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .user-item, .prediction-item, .result-item, .match-item, .winner-item {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-item:last-child, .prediction-item:last-child, .result-item:last-child, .match-item:last-child, .winner-item:last-child {
            border-bottom: none;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        canvas {
            margin: 20px 0;
            max-width: 100%;
        }
        .admin-section {
            margin-bottom: 30px;
        }
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        .match-prediction {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        .radio-group label {
            font-weight: normal;
            margin-bottom: 0;
        }
        .timer {
            font-size: 14px;
            color: #555;
            margin-bottom: 10px;
        }
        .timer.expired {
            color: red;
        }
        .pie-charts-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }
        .pie-chart-item {
            width: 200px;
            text-align: center;
        }
        .pie-chart-item h4 {
            margin-bottom: 10px;
        }
        @media (max-width: 600px) {
            .tabs, .sub-tabs {
                flex-direction: column;
                align-items: center;
            }
            .tab, .sub-tab {
                width: 100%;
                text-align: center;
                margin: 5px 0;
            }
            table {
                font-size: 14px;
            }
            .radio-group {
                flex-direction: column;
                gap: 10px;
            }
            canvas {
                max-width: 100%;
            }
            .pie-chart-item {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <h1>IPLBanters 2025</h1>

    <div class="tabs">
        <div class="tab active" data-tab="predict">Predict</div>
        <div class="tab" data-tab="predictions">Predictions</div>
        <div class="tab" data-tab="leaderboard">Leaderboard</div>
        <div class="tab" data-tab="admin" id="adminTab">Admin</div>
    </div>

    <div class="tab-content active" id="predict">
        <div class="form-container">
            <h2>Make Predictions</h2>
            <label for="predictUserId">Select User:</label>
            <select id="predictUserId" required>
                <option value="">Select a user</option>
            </select>
            <div id="predictMatches"></div>
            <div id="predictError" class="error"></div>
            <div id="predictSuccess" class="success"></div>
            <button id="submitPredictions" type="button">Submit Predictions</button>
        </div>
    </div>

    <div class="tab-content" id="predictions">
        <div class="predictions">
            <h2>Live Predictions</h2>
            <div id="predictionsList"></div>
            <h3>Live Predictions by Team</h3>
            <canvas id="predictionsPieChart"></canvas>
        </div>
    </div>

    <div class="tab-content" id="leaderboard">
        <div class="leaderboard">
            <h2>Leaderboard</h2>
            <div id="leaderboardList"></div>
            <h3>User Predictions and Wins</h3>
            <canvas id="userBarChart"></canvas>
            <h3>User Win/Loss Distribution</h3>
            <div id="userPieCharts" class="pie-charts-container"></div>
        </div>
    </div>

    <div class="tab-content" id="admin">
        <div class="admin-container">
            <h2>Admin Dashboard</h2>
            <button id="logoutAdmin" class="danger-button small-button">Logout</button>
            <div class="sub-tabs">
                <div class="sub-tab active" data-sub-tab="admin-users">Users</div>
                <div class="sub-tab" data-sub-tab="admin-schedule">Schedule</div>
                <div class="sub-tab" data-sub-tab="admin-results">Results</div>
            </div>
            <div class="sub-tab-content active" id="admin-users">
                <div class="user-container">
                    <h3 id="userFormTitle">Add User</h3>
                    <form id="adminUserForm">
                        <label for="adminNewUserName">User Name:</label>
                        <input type="text" id="adminNewUserName" placeholder="Enter user name" required>
                        <label><input type="checkbox" id="isAdmin"> Admin User</label>
                        <div id="adminUserError" class="error"></div>
                        <div id="adminUserSuccess" class="success"></div>
                        <button type="submit">Add User</button>
                    </form>
                    <div class="users-list">
                        <h3>Registered Users</h3>
                        <div id="userList"></div>
                    </div>
                </div>
            </div>
            <div class="sub-tab-content" id="admin-schedule">
                <div class="admin-section">
                    <h3>Import Schedule (CSV)</h3>
                    <p>Format: date,team1,team2,time,venue (e.g., 2025-04-13,RR,RCB,15:30,Sawai Mansingh Stadium)</p>
                    <input type="file" id="matchCsv" accept=".csv">
                    <div id="csvError" class="error"></div>
                    <div id="csvSuccess" class="success"></div>
                </div>
                <div class="admin-section">
                    <h3>Add Match Manually</h3>
                    <form id="matchForm">
                        <label for="matchDateAdmin">Match Date:</label>
                        <input type="date" id="matchDateAdmin" required>
                        <label for="matchTimeAdmin">Match Time (IST):</label>
                        <select id="matchTimeAdmin" required>
                            <option value="">Select time</option>
                            <option value="15:30">3:30 PM IST</option>
                            <option value="19:30">7:30 PM IST</option>
                        </select>
                        <label for="matchTeam1">Team 1:</label>
                        <select id="matchTeam1" required>
                            <option value="">Select Team 1</option>
                            <option value="CSK">CSK</option>
                            <option value="MI">MI</option>
                            <option value="RCB">RCB</option>
                            <option value="KKR">KKR</option>
                            <option value="SRH">SRH</option>
                            <option value="RR">RR</option>
                            <option value="GT">GT</option>
                            <option value="DC">DC</option>
                            <option value="LSG">LSG</option>
                            <option value="PBKS">PBKS</option>
                        </select>
                        <label for="matchTeam2">Team 2:</label>
                        <select id="matchTeam2" required>
                            <option value="">Select Team 2</option>
                            <option value="CSK">CSK</option>
                            <option value="MI">MI</option>
                            <option value="RCB">RCB</option>
                            <option value="KKR">KKR</option>
                            <option value="SRH">SRH</option>
                            <option value="RR">RR</option>
                            <option value="GT">GT</option>
                            <option value="DC">DC</option>
                            <option value="LSG">LSG</option>
                            <option value="PBKS">PBKS</option>
                        </select>
                        <label for="matchVenue">Venue:</label>
                        <input type="text" id="matchVenue" placeholder="Enter venue (e.g., Wankhede Stadium)" required>
                        <div id="matchError" class="error"></div>
                        <div id="matchSuccess" class="success"></div>
                        <button type="submit">Add Match</button>
                    </form>
                    <div class="matches-list">
                        <h3>IPL 2025 Schedule</h3>
                        <div id="matchList"></div>
                    </div>
                </div>
            </div>
            <div class="sub-tab-content" id="admin-results">
                <div class="results-container">
                    <h3>Add Match Result</h3>
                    <form id="resultForm">
                        <label for="matchSelect">Select Match:</label>
                        <select id="matchSelect" required>
                            <option value="">Select a match</option>
                        </select>
                        <label for="resultDate">Match Date:</label>
                        <input type="date" id="resultDate" readonly>
                        <label for="team1">Team 1:</label>
                        <input type="text" id="team1" readonly>
                        <label for="team2">Team 2:</label>
                        <input type="text" id="team2" readonly>
                        <label>Winner:</label>
                        <div class="radio-group" id="winnerRadio">
                            <!-- Populated dynamically -->
                        </div>
                        <div id="resultError" class="error"></div>
                        <button type="submit">Add Result</button>
                    </form>
                    <div class="results-list">
                        <h3>Match Results</h3>
                        <div id="resultList"></div>
                    </div>
                    <div class="winners-list">
                        <h3>Winning Teams</h3>
                        <div id="winnersList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Generate unique ID
        function generateId() {
            return Math.random().toString(36).substr(2, 9);
        }

        // Valid teams
        const validTeams = ["CSK", "MI", "RCB", "KKR", "SRH", "RR", "GT", "DC", "LSG", "PBKS"];
        const ADMIN_PASSWORD = "Dhoni123";

        // Initialize data
        let users = JSON.parse(localStorage.getItem('users')) || [
            { id: generateId(), name: "Vaibhav", isAdmin: true }
        ];
        let predictions = JSON.parse(localStorage.getItem('predictions')) || [];
        let results = JSON.parse(localStorage.getItem('results')) || [];
        let iplSchedule = JSON.parse(localStorage.getItem('iplSchedule')) || [];
        let drsUsed = JSON.parse(localStorage.getItem('drsUsed')) || [];

        // Save data
        function saveUsers() {
            try {
                localStorage.setItem('users', JSON.stringify(users));
                console.log('Saved users:', users);
            } catch (e) {
                console.error('Failed to save users:', e);
            }
        }

        function savePredictions() {
            try {
                localStorage.setItem('predictions', JSON.stringify(predictions));
                console.log('Saved predictions:', predictions);
            } catch (e) {
                console.error('Failed to save predictions:', e);
            }
        }

        function saveResults() {
            try {
                localStorage.setItem('results', JSON.stringify(results));
                console.log('Saved results:', results);
            } catch (e) {
                console.error('Failed to save results:', e);
            }
        }

        function saveIplSchedule() {
            try {
                localStorage.setItem('iplSchedule', JSON.stringify(iplSchedule));
                console.log('Saved schedule:', iplSchedule);
            } catch (e) {
                console.error('Failed to save schedule:', e);
            }
        }

        function saveDrsUsed() {
            try {
                localStorage.setItem('drsUsed', JSON.stringify(drsUsed));
                console.log('Saved DRS used:', drsUsed);
            } catch (e) {
                console.error('Failed to save DRS used:', e);
            }
        }

        // Admin login
        function checkAdminAccess(tabId) {
            if (localStorage.getItem('adminLoggedIn') === 'true') {
                switchTab(tabId);
                return;
            }
            const password = prompt('Enter admin password:');
            if (password === ADMIN_PASSWORD) {
                localStorage.setItem('adminLoggedIn', 'true');
                switchTab(tabId);
            } else {
                alert('Incorrect password');
                switchTab('predict');
            }
        }

        // Switch main tab
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
            console.log(`Switched to tab: ${tabId}`);

            if (tabId === 'predict') displayPredict();
            else if (tabId === 'predictions') displayPredictions();
            else if (tabId === 'leaderboard') displayLeaderboard();
            else if (tabId === 'admin') {
                switchSubTab('admin-users');
            }
        }

        // Switch admin sub-tab
        function switchSubTab(subTabId) {
            document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sub-tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.sub-tab[data-sub-tab="${subTabId}"]`).classList.add('active');
            document.getElementById(subTabId).classList.add('active');
            console.log(`Switched to sub-tab: ${subTabId}`);

            if (subTabId === 'admin-users') displayAdminUsers();
            else if (subTabId === 'admin-schedule') displayAdminSchedule();
            else if (subTabId === 'admin-results') displayAdminResults();
        }

        // Tab navigation
        function initializeTabs() {
            const tabs = document.querySelectorAll('.tab');
            const subTabs = document.querySelectorAll('.sub-tab');
            const isAdminLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';

            document.getElementById('adminTab').classList.remove('hidden');
            switchTab(isAdminLoggedIn ? 'admin' : 'predict');

            tabs.forEach(tab => {
                tab.removeEventListener('click', handleTabClick);
                tab.addEventListener('click', handleTabClick);
            });

            subTabs.forEach(subTab => {
                subTab.removeEventListener('click', handleSubTabClick);
                subTab.addEventListener('click', handleSubTabClick);
            });

            function handleTabClick(e) {
                const tab = e.currentTarget;
                const tabId = tab.dataset.tab;
                console.log(`Tab clicked: ${tabId}`);

                if (tabId === 'admin' && localStorage.getItem('adminLoggedIn') !== 'true') {
                    checkAdminAccess(tabId);
                    return;
                }

                switchTab(tabId);
            }

            function handleSubTabClick(e) {
                const subTab = e.currentTarget;
                const subTabId = subTab.dataset.subTab;
                console.log(`Sub-tab clicked: ${subTabId}`);
                switchSubTab(subTabId);
            }
        }

        // Admin logout
        document.getElementById('logoutAdmin').addEventListener('click', () => {
            console.log('Admin logout clicked');
            localStorage.removeItem('adminLoggedIn');
            switchTab('predict');
        });

        // CSV import
        function handleCsvImport(e) {
            const error = document.getElementById('csvError');
            const success = document.getElementById('csvSuccess');
            error.textContent = '';
            success.textContent = '';

            if (!e.target.files[0]) {
                error.textContent = 'No file selected.';
                return;
            }

            Papa.parse(e.target.files[0], {
                header: true,
                skipEmptyLines: true,
                complete: results => {
                    let added = 0;
                    results.data.forEach(row => {
                        if (!row.date || !row.team1 || !row.team2 || !row.time || !row.venue) {
                            console.warn('Skipping invalid row:', row);
                            return;
                        }
                        if (!validTeams.includes(row.team1) || !validTeams.includes(row.team2)) {
                            console.warn('Invalid teams:', row.team1, row.team2);
                            return;
                        }
                        if (row.team1 === row.team2) {
                            console.warn('Same teams:', row.team1);
                            return;
                        }
                        if (!['15:30', '19:30'].includes(row.time)) {
                            console.warn('Invalid time:', row.time);
                            return;
                        }
                        if (iplSchedule.some(m => m.date === row.date && m.team1 === row.team1 && m.team2 === row.team2)) {
                            console.warn('Duplicate match:', row.date, row.team1, row.team2);
                            return;
                        }
                        if (!/^\d{4}-\d{2}-\d{2}$/.test(row.date)) {
                            console.warn('Invalid date format:', row.date);
                            return;
                        }

                        const istDateTime = new Date(`${row.date}T${row.time}:00+05:30`);
                        if (isNaN(istDateTime.getTime())) {
                            console.warn('Invalid date/time:', row.date, row.time);
                            return;
                        }
                        istDateTime.setMinutes(istDateTime.getMinutes() - 30);
                        const deadline = istDateTime.toISOString();

                        iplSchedule.push({
                            id: generateId(),
                            date: row.date,
                            team1: row.team1,
                            team2: row.team2,
                            time: row.time,
                            deadline,
                            venue: row.venue.trim()
                        });
                        added++;
                    });

                    if (added === 0) {
                        error.textContent = 'No valid matches added. Check CSV format.';
                        return;
                    }

                    saveIplSchedule();
                    success.textContent = `Added ${added} matches!`;
                    console.log('Imported matches:', iplSchedule);
                    displayAdminSchedule();
                    displayPredict();
                    displayAdminResults();
                    e.target.value = '';
                },
                error: err => {
                    error.textContent = 'Failed to parse CSV: ' + err.message;
                    console.error('CSV parse error:', err);
                }
            });
        }

        // Display admin users
        function displayAdminUsers() {
            const userList = document.getElementById('userList');
            userList.innerHTML = users.map(user => `
                <div class="user-item">
                    <span>${user.name}${user.isAdmin ? ' (Admin)' : ''}</span>
                    <div class="action-buttons">
                        <button class="edit-button edit-user small-button" data-id="${user.id}">Edit</button>
                        <button class="danger-button delete-user small-button" data-id="${user.id}" ${predictions.some(p => p.userId === user.id) ? 'disabled' : ''}>Delete</button>
                    </div>
                </div>
            `).join('');

            // Edit user
            document.querySelectorAll('.edit-user').forEach(btn => {
                btn.addEventListener('click', () => {
                    const userId = btn.dataset.id;
                    const user = users.find(u => u.id === userId);
                    if (user) {
                        document.getElementById('userFormTitle').textContent = 'Edit User';
                        document.getElementById('adminNewUserName').value = user.name;
                        document.getElementById('isAdmin').checked = user.isAdmin;
                        document.getElementById('adminUserForm').dataset.id = userId;
                        document.getElementById('adminUserForm').querySelector('button').textContent = 'Update User';
                    }
                });
            });

            // Delete user
            document.querySelectorAll('.delete-user').forEach(btn => {
                btn.addEventListener('click', () => {
                    const userId = btn.dataset.id;
                    if (confirm(`Delete user "${users.find(u => u.id === userId).name}"?`)) {
                        users = users.filter(u => u.id !== userId);
                        predictions = predictions.filter(p => p.userId !== userId);
                        drsUsed = drsUsed.filter(d => d.userId !== userId);
                        saveUsers();
                        savePredictions();
                        saveDrsUsed();
                        displayAdminUsers();
                        displayLeaderboard();
                        populateUserDropdowns();
                    }
                });
            });

            populateUserDropdowns();
        }

        // Display admin schedule
        function displayAdminSchedule() {
            const matchList = document.getElementById('matchList');
            matchList.innerHTML = iplSchedule.map(m => `
                <div class="match-item">
                    <span>${m.date}: ${m.team1} vs ${m.team2}, ${m.time} IST, Deadline: ${m.deadline ? new Date(m.deadline).toLocaleString('en-US', { dateStyle: 'short', timeStyle: 'short' }) : 'No deadline'}${m.venue ? `, ${m.venue}` : ''}</span>
                    <button class="danger-button delete-match small-button" data-id="${m.id}">Delete</button>
                </div>
            `).join('');

            document.querySelectorAll('.delete-match').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (confirm('Delete this match?')) {
                        const matchId = btn.dataset.id;
                        iplSchedule = iplSchedule.filter(m => m.id !== matchId);
                        predictions = predictions.filter(p => p.matchId !== matchId);
                        drsUsed = drsUsed.filter(d => d.matchId !== matchId);
                        results = results.filter(r => !iplSchedule.some(m => m.id === r.matchId && m.id === matchId));
                        saveIplSchedule();
                        savePredictions();
                        saveDrsUsed();
                        saveResults();
                        displayAdminSchedule();
                        displayPredict();
                        displayAdminResults();
                    }
                });
            });
        }

        // Populate match dropdown and update form
        function populateMatchDropdown(editingMatchId = null) {
            const matchSelect = document.getElementById('matchSelect');
            const existingResultMatchIds = results.map(r => r.matchId);
            const availableMatches = iplSchedule
                .filter(m => !existingResultMatchIds.includes(m.id) || m.id === editingMatchId)
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            matchSelect.innerHTML = '<option value="">Select a match</option>' +
                availableMatches.map(m => `
                    <option value="${m.id}" ${m.id === editingMatchId ? 'selected' : ''}>${m.date}: ${m.team1} vs ${m.team2}</option>
                `).join('');

            // Trigger change event if editing to populate fields
            if (editingMatchId) {
                matchSelect.dispatchEvent(new Event('change'));
            }

            matchSelect.addEventListener('change', () => {
                const matchId = matchSelect.value;
                const match = iplSchedule.find(m => m.id === matchId);
                const resultDate = document.getElementById('resultDate');
                const team1 = document.getElementById('team1');
                const team2 = document.getElementById('team2');
                const winnerRadio = document.getElementById('winnerRadio');

                if (match) {
                    resultDate.value = match.date;
                    team1.value = match.team1;
                    team2.value = match.team2;
                    winnerRadio.innerHTML = `
                        <label><input type="radio" name="winner" value="${match.team1}" required> ${match.team1}</label>
                        <label><input type="radio" name="winner" value="${match.team2}"> ${match.team2}</label>
                    `;
                } else {
                    resultDate.value = '';
                    team1.value = '';
                    team2.value = '';
                    winnerRadio.innerHTML = '';
                }
            }, { once: true });
        }

        // Display admin results
        function displayAdminResults() {
            populateMatchDropdown();

            const resultList = document.getElementById('resultList');
            resultList.innerHTML = results.map(r => {
                const match = iplSchedule.find(m => m.id === r.matchId);
                return match ? `
                    <div class="result-item">
                        <span>${match.date}: ${match.team1} vs ${match.team2}, Winner: ${r.winner}</span>
                        <div class="action-buttons">
                            <button class="edit-button edit-result small-button" data-id="${r.id}" data-match-id="${r.matchId}">Edit</button>
                            <button class="danger-button delete-result small-button" data-id="${r.id}">Delete</button>
                        </div>
                    </div>
                ` : '';
            }).join('');

            document.querySelectorAll('.edit-result').forEach(btn => {
                btn.addEventListener('click', () => {
                    const resultId = btn.dataset.id;
                    const matchId = btn.dataset.matchId;
                    const result = results.find(r => r.id === resultId);
                    const match = iplSchedule.find(m => m.id === matchId);
                    if (match && result) {
                        populateMatchDropdown(matchId);
                        document.getElementById('resultDate').value = match.date;
                        document.getElementById('team1').value = match.team1;
                        document.getElementById('team2').value = match.team2;
                        document.getElementById('winnerRadio').innerHTML = `
                            <label><input type="radio" name="winner" value="${match.team1}" ${result.winner === match.team1 ? 'checked' : ''} required> ${match.team1}</label>
                            <label><input type="radio" name="winner" value="${match.team2}" ${result.winner === match.team2 ? 'checked' : ''}> ${match.team2}</label>
                        `;
                        document.getElementById('resultForm').dataset.id = resultId;
                    }
                });
            });

            document.querySelectorAll('.delete-result').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (confirm('Delete this result?')) {
                        results = results.filter(r => r.id !== btn.dataset.id);
                        saveResults();
                        displayAdminResults();
                        displayLeaderboard();
                    }
                });
            });

            // Winning teams
            const winnersList = document.getElementById('winnersList');
            const teamWins = {};
            results.forEach(r => {
                const match = iplSchedule.find(m => m.id === r.matchId);
                if (match) {
                    teamWins[r.winner] = teamWins[r.winner] || { count: 0, matches: [] };
                    teamWins[r.winner].count++;
                    teamWins[r.winner].matches.push(`${match.date}: ${match.team1} vs ${match.team2}`);
                }
            });

            winnersList.innerHTML = Object.keys(teamWins).length > 0 ? `
                <table>
                    <thead>
                        <tr>
                            <th>Team</th>
                            <th>Wins</th>
                            <th>Matches Won</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(teamWins)
                            .sort((a, b) => b[1].count - a[1].count)
                            .map(([team, data]) => `
                                <tr>
                                    <td>${team}</td>
                                    <td>${data.count}</td>
                                    <td>${data.matches.join('<br>')}</td>
                                </tr>
                            `).join('')}
                    </tbody>
                </table>
            ` : '<p>No winning teams yet.</p>';
        }

        // Populate user dropdown
        function populateUserDropdowns() {
            const userSelect = document.getElementById('predictUserId');
            userSelect.innerHTML = '<option value="">Select a user</option>' +
                users.map(user => `<option value="${user.id}">${user.name}</option>`).join('');

            // Add change listener to update Predict tab
            userSelect.removeEventListener('change', handleUserChange);
            userSelect.addEventListener('change', handleUserChange);

            function handleUserChange() {
                console.log('User changed to:', userSelect.value);
                displayPredict();
            }
        }

        // Format timer
        function formatTimer(deadline, matchId) {
            const now = new Date().getTime();
            if (!deadline || now >= deadline) {
                return `<span class="timer expired" id="timer-${matchId}">Prediction closed</span>`;
            }

            const diff = deadline - now;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            return `<span class="timer" id="timer-${matchId}">Time left: ${hours}h ${minutes}m ${seconds}s</span>`;
        }

        // Update timers
        function updateTimers() {
            const today = new Date().toISOString().split('T')[0];
            const todayMatches = iplSchedule.filter(m => m.date === today);
            todayMatches.forEach(match => {
                const timerElement = document.getElementById(`timer-${match.id}`);
                if (timerElement) {
                    const deadline = match.deadline ? new Date(match.deadline).getTime() : null;
                    timerElement.outerHTML = formatTimer(deadline, match.id);
                }
            });
        }

        // Display predict tab
        function displayPredict() {
            const matchesContainer = document.getElementById('predictMatches');
            const userId = document.getElementById('predictUserId').value;
            const today = new Date().toISOString().split('T')[0];
            const todayMatches = iplSchedule.filter(m => m.date === today);

            if (todayMatches.length === 0 || !userId) {
                matchesContainer.innerHTML = todayMatches.length === 0 ? '<p>No matches scheduled for today.</p>' : '<p>Please select a user.</p>';
                document.getElementById('submitPredictions').style.display = 'none';
                clearInterval(window.timerInterval);
                return;
            }

            document.getElementById('submitPredictions').style.display = 'block';
            matchesContainer.innerHTML = todayMatches.map(match => {
                const hasPredicted = predictions.some(p => p.userId === userId && p.matchId === match.id);
                const drsWasUsed = drsUsed.some(d => d.userId === userId && d.matchId === match.id);
                const currentPrediction = hasPredicted ? predictions.find(p => p.userId === userId && p.matchId === match.id) : null;
                const deadline = match.deadline ? new Date(match.deadline).getTime() : null;
                const isExpired = !deadline || new Date().getTime() >= deadline;
                const localDeadline = match.deadline ? new Date(match.deadline).toLocaleString('en-US', { timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone, dateStyle: 'short', timeStyle: 'short' }) : 'No deadline';

                return `
                    <div class="match-prediction">
                        <h4>${match.date}: ${match.team1} vs ${match.team2} (${match.time} IST)${match.venue ? `, ${match.venue}` : ''}</h4>
                        <p>Prediction deadline: ${localDeadline}</p>
                        ${formatTimer(deadline, match.id)}
                        ${isExpired ? `
                            <p>Prediction closed</p>
                        ` : hasPredicted ? `
                            <p>Current prediction: ${currentPrediction.team}</p>
                            ${drsWasUsed ? '<p>DRS already used.</p>' : `
                                <button class="drs-button" data-match-id="${match.id}">Use DRS</button>
                                <div class="radio-group drs-radio-${match.id}" style="display: none;">
                                    <label><input type="radio" name="drs-match-${match.id}" value="${match.team1}" required> ${match.team1}</label>
                                    <label><input type="radio" name="drs-match-${match.id}" value="${match.team2}"> ${match.team2}</label>
                                </div>
                            `}
                        ` : `
                            <div class="radio-group">
                                <label><input type="radio" name="match-${match.id}" value="${match.team1}" required> ${match.team1}</label>
                                <label><input type="radio" name="match-${match.id}" value="${match.team2}"> ${match.team2}</label>
                            </div>
                        `}
                    </div>
                `;
            }).join('');

            document.querySelectorAll('.drs-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    const matchId = btn.dataset.matchId;
                    console.log(`DRS clicked for match: ${matchId}`);
                    btn.style.display = 'none';
                    document.querySelector(`.drs-radio-${matchId}`).style.display = 'flex';
                });
            });

            clearInterval(window.timerInterval);
            window.timerInterval = setInterval(updateTimers, 1000);
        }

        // Display predictions tab with pie chart
        let predictionsPieChartInstance = null;
        function displayPredictions() {
            const list = document.getElementById('predictionsList');
            const now = new Date().getTime();
            const livePredictions = predictions.filter(p => {
                const match = iplSchedule.find(m => m.id === p.matchId);
                return match && match.deadline && now < new Date(match.deadline).getTime();
            });

            list.innerHTML = livePredictions.length > 0 ? `
                <table>
                    <thead><tr><th>Date</th><th>User</th><th>Match</th><th>Team</th></tr></thead>
                    <tbody>
                        ${livePredictions.map(p => {
                            const user = users.find(u => u.id === p.userId);
                            const match = iplSchedule.find(m => m.id === p.matchId);
                            return user && match ? `
                                <tr>
                                    <td>${p.date}</td>
                                    <td>${user.name}</td>
                                    <td>${match.team1} vs ${match.team2}</td>
                                    <td>${p.team}</td>
                                </tr>
                            ` : '';
                        }).join('')}
                    </tbody>
                </table>
            ` : '<p>No live predictions available.</p>';

            // Pie chart
            if (predictionsPieChartInstance) predictionsPieChartInstance.destroy();
            const ctx = document.getElementById('predictionsPieChart').getContext('2d');
            const teamCounts = {};
            const teamUsers = {};
            livePredictions.forEach(p => {
                teamCounts[p.team] = (teamCounts[p.team] || 0) + 1;
                const user = users.find(u => u.id === p.userId);
                if (user) {
                    teamUsers[p.team] = teamUsers[p.team] || [];
                    teamUsers[p.team].push(user.name);
                }
            });

            const labels = Object.keys(teamCounts);
            const data = Object.values(teamCounts);
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#C9CBCF', '#7BC225', '#F7A4B0', '#5AD3D1'
            ].slice(0, labels.length);

            predictionsPieChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: 'Live Predictions by Team'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const team = context.label;
                                    const count = context.raw;
                                    const usersList = teamUsers[team] || [];
                                    return `${team}: ${count} (${usersList.join(', ')})`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Display leaderboard
        let userBarChartInstance = null;
        let userPieChartInstances = [];
        function displayLeaderboard() {
            const leaderboardList = document.getElementById('leaderboardList');
            const stats = users.map(user => {
                const userPredictions = predictions.filter(p => p.userId === user.id);
                const wins = userPredictions.filter(p => {
                    const result = results.find(r => 
                        r.matchId === p.matchId && r.winner === p.team
                    );
                    return !!result;
                }).length;
                const total = userPredictions.length;
                const winPercent = total > 0 ? ((wins / total) * 100).toFixed(2) : '0.00';
                return { 
                    name: user.name, 
                    total: parseInt(total), 
                    wins: parseInt(wins), 
                    winPercent: parseFloat(winPercent)
                };
            });

            stats.sort((a, b) => {
                if (b.wins !== a.wins) return b.wins - a.wins;
                return b.winPercent - a.winPercent;
            });

            let lastWins = null;
            let lastWinPercent = null;
            let currentRank = 0;
            const rankedStats = stats.map((stat, index) => {
                if (stat.wins !== lastWins || stat.winPercent !== lastWinPercent) {
                    currentRank = index + 1;
                }
                lastWins = stat.wins;
                lastWinPercent = stat.winPercent;
                return { ...stat, rank: currentRank };
            });

            leaderboardList.innerHTML = rankedStats.length > 0 ? `
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>User</th>
                            <th>Total Predictions</th>
                            <th>Total Wins</th>
                            <th>Win%</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rankedStats.map(s => `
                            <tr>
                                <td>${s.rank}</td>
                                <td>${s.name}</td>
                                <td>${s.total}</td>
                                <td>${s.wins}</td>
                                <td>${s.winPercent}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p>No leaderboard data available.</p>';

            // Bar chart
            if (userBarChartInstance) userBarChartInstance.destroy();
            const barCtx = document.getElementById('userBarChart').getContext('2d');
            userBarChartInstance = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: stats.map(s => s.name),
                    datasets: [
                        {
                            label: 'Total Predictions',
                            data: stats.map(s => parseInt(s.total)),
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Total Wins',
                            data: stats.map(s => parseInt(s.wins)),
                            backgroundColor: 'rgba(75, 192, 192, 0.5)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Count'
                            },
                            ticks: {
                                stepSize: 1,
                                precision: 0
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Users'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: 'User Predictions and Wins'
                        }
                    }
                }
            });

            // Pie charts
            const pieContainer = document.getElementById('userPieCharts');
            pieContainer.innerHTML = '';
            userPieChartInstances.forEach(instance => instance.destroy());
            userPieChartInstances = [];

            stats.forEach(stat => {
                const div = document.createElement('div');
                div.className = 'pie-chart-item';
                div.innerHTML = `<h4>${stat.name}</h4><canvas id="pie-${stat.name.replace(/\s/g, '-')}" style="max-height: 150px;"></canvas>`;
                pieContainer.appendChild(div);

                const ctx = document.getElementById(`pie-${stat.name.replace(/\s/g, '-')}`).getContext('2d');
                const pieChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: stat.total > 0 ? ['Wins', 'Losses'] : ['No Data'],
                        datasets: [{
                            data: stat.total > 0 ? [parseInt(stat.wins), parseInt(stat.total - stat.wins)] : [1],
                            backgroundColor: stat.total > 0 ? ['#36A2EB', '#FF6384'] : ['#C9CBCF'],
                            borderColor: stat.total > 0 ? ['#36A2EB', '#FF6384'] : ['#C9CBCF'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top'
                            },
                            title: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        if (stat.total === 0) return 'No Predictions';
                                        const label = context.label;
                                        const value = context.raw;
                                        return `${label}: ${value}`;
                                    }
                                }
                            }
                        }
                    }
                });
                userPieChartInstances.push(pieChart);
            });
        }

        // Admin user form
        document.getElementById('adminUserForm').addEventListener('submit', e => {
            e.preventDefault();
            const userName = document.getElementById('adminNewUserName').value.trim();
            const isAdmin = document.getElementById('isAdmin').checked;
            const userError = document.getElementById('adminUserError');
            const userSuccess = document.getElementById('adminUserSuccess');
            const form = e.target;
            const userId = form.dataset.id;

            console.log('Admin user form submitted:', { userName, isAdmin, userId });

            if (!userName) {
                userError.textContent = 'User name is required.';
                userSuccess.textContent = '';
                return;
            }
            if (!userId && users.some(u => u.name.toLowerCase() === userName.toLowerCase())) {
                userError.textContent = 'User name already exists.';
                userSuccess.textContent = '';
                return;
            }
            if (userId && users.some(u => u.id !== userId && u.name.toLowerCase() === userName.toLowerCase())) {
                userError.textContent = 'User name already taken by another user.';
                userSuccess.textContent = '';
                return;
            }

            if (userId) {
                users = users.map(u => u.id === userId ? { ...u, name: userName, isAdmin } : u);
                userSuccess.textContent = `Updated ${userName}${isAdmin ? ' as admin' : ''}!`;
            } else {
                users.push({ id: generateId(), name: userName, isAdmin });
                userSuccess.textContent = `Added ${userName}${isAdmin ? ' as admin' : ''}!`;
            }

            saveUsers();
            userError.textContent = '';
            form.reset();
            delete form.dataset.id;
            document.getElementById('userFormTitle').textContent = 'Add User';
            document.getElementById('adminUserForm').querySelector('button').textContent = 'Add User';
            displayAdminUsers();
            displayLeaderboard();
        });

        // CSV import
        document.getElementById('matchCsv').addEventListener('change', handleCsvImport);

        // Manual match form
        document.getElementById('matchForm').addEventListener('submit', e => {
            e.preventDefault();
            const date = document.getElementById('matchDateAdmin').value;
            const time = document.getElementById('matchTimeAdmin').value;
            const team1 = document.getElementById('matchTeam1').value;
            const team2 = document.getElementById('matchTeam2').value;
            const venue = document.getElementById('matchVenue').value.trim();
            const error = document.getElementById('matchError');
            const success = document.getElementById('matchSuccess');

            console.log('Manual match form submitted:', { date, time, team1, team2, venue });

            if (!date || !time || !team1 || !team2 || !venue) {
                error.textContent = 'All fields required.';
                success.textContent = '';
                return;
            }
            if (team1 === team2) {
                error.textContent = 'Teams must be different.';
                success.textContent = '';
                return;
            }
            if (iplSchedule.some(m => m.date === date && m.team1 === team1 && m.team2 === team2)) {
                error.textContent = 'Match already exists.';
                success.textContent = '';
                return;
            }

            const istDateTime = new Date(`${date}T${time}:00+05:30`);
            istDateTime.setMinutes(istDateTime.getMinutes() - 30);
            const deadline = istDateTime.toISOString();

            iplSchedule.push({
                id: generateId(),
                date,
                team1,
                team2,
                time,
                deadline,
                venue
            });
            saveIplSchedule();
            error.textContent = '';
            success.textContent = 'Match added!';
            e.target.reset();
            displayAdminSchedule();
            displayPredict();
            displayAdminResults();
        });

        // Result form
        document.getElementById('resultForm').addEventListener('submit', e => {
            e.preventDefault();
            const form = e.target;
            const matchId = document.getElementById('matchSelect').value;
            const winner = document.querySelector('input[name="winner"]:checked')?.value;
            const error = document.getElementById('resultError');

            console.log('Result form submitted:', { matchId, winner });

            if (!matchId) {
                error.textContent = 'Please select a match.';
                return;
            }
            if (!winner) {
                error.textContent = 'Please select a winner.';
                return;
            }

            const match = iplSchedule.find(m => m.id === matchId);
            if (!match) {
                error.textContent = 'Invalid match selected.';
                return;
            }
            if (![match.team1, match.team2].includes(winner)) {
                error.textContent = 'Winner must be Team 1 or Team 2.';
                return;
            }

            if (form.dataset.id) {
                results = results.map(r => r.id === form.dataset.id ? { id: r.id, matchId, date: match.date, team1: match.team1, team2: match.team2, winner } : r);
            } else {
                results.push({ id: generateId(), matchId, date: match.date, team1: match.team1, team2: match.team2, winner });
            }

            saveResults();
            error.textContent = '';
            form.reset();
            delete form.dataset.id;
            document.getElementById('resultDate').value = '';
            document.getElementById('team1').value = '';
            document.getElementById('team2').value = '';
            document.getElementById('winnerRadio').innerHTML = '';
            displayAdminResults();
            displayLeaderboard();
        });

        // Predict form submission
        document.getElementById('submitPredictions').addEventListener('click', () => {
            const userId = document.getElementById('predictUserId').value;
            const error = document.getElementById('predictError');
            const success = document.getElementById('predictSuccess');
            const today = new Date().toISOString().split('T')[0];
            const todayMatches = iplSchedule.filter(m => m.date === today);

            console.log('Submit predictions clicked:', { userId });

            if (!userId) {
                error.textContent = 'Please select a user.';
                success.textContent = '';
                return;
            }

            let allValid = true;
            const newPredictions = [];
            const updatedPredictions = [];

            todayMatches.forEach(match => {
                const hasPredicted = predictions.some(p => p.userId === userId && p.matchId === match.id);
                const drsWasUsed = drsUsed.some(d => d.userId === userId && d.matchId === match.id);
                const isExpired = match.deadline && new Date().getTime() >= new Date(match.deadline).getTime();

                if (isExpired) return;

                if (!hasPredicted) {
                    const selectedTeam = document.querySelector(`input[name="match-${match.id}"]:checked`);
                    if (!selectedTeam) {
                        allValid = false;
                        return;
                    }
                    newPredictions.push({
                        userId,
                        matchId: match.id,
                        date: match.date,
                        team: selectedTeam.value
                    });
                } else if (!drsWasUsed) {
                    const drsTeam = document.querySelector(`input[name="drs-match-${match.id}"]:checked`);
                    if (drsTeam) {
                        updatedPredictions.push({
                            userId,
                            matchId: match.id,
                            date: match.date,
                            team: drsTeam.value
                        });
                        drsUsed.push({ userId, matchId: match.id });
                    }
                }
            });

            if (!allValid) {
                error.textContent = 'Please select a team for each new match.';
                success.textContent = '';
                return;
            }

            if (newPredictions.length === 0 && updatedPredictions.length === 0) {
                error.textContent = 'No new or updated predictions to submit.';
                success.textContent = '';
                return;
            }

            updatedPredictions.forEach(update => {
                predictions = predictions.map(p =>
                    p.userId === update.userId && p.matchId === update.matchId ? update : p
                );
            });

            predictions.push(...newPredictions);

            savePredictions();
            saveDrsUsed();
            error.textContent = '';
            success.textContent = 'Predictions submitted!';
            displayPredict();
            displayPredictions();
            displayLeaderboard();
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('App initialized');
            initializeTabs();
            displayPredict();
            displayPredictions();
            displayLeaderboard();
            if (localStorage.getItem('adminLoggedIn') === 'true') {
                switchTab('admin');
            }
        });

        // PWA setup
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js').catch(err => console.error('Service Worker error:', err));
        }
    </script>
</body>
</html>
